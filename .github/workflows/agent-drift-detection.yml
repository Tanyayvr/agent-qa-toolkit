# .github/workflows/agent-drift-detection.yml
#
# Scenario 4: Overnight Drift Detection CI Run
#
# PURPOSE:
#   Runs the full agent evaluation suite every night (and on demand).
#   Compares baseline artifacts vs new to detect model drift, silent regressions,
#   or behavior changes that occur WITHOUT code changes (e.g. model version updates).
#
# OUTPUTS:
#   - compare-report.json  â†’ gate_recommendation field for CI decision
#   - flakiness.json       â†’ per-case pass_rate (written when --runs > 1)
#   - report.html          â†’ human-readable drift report
#   - run.json             â†’ git_commit + git_branch in artifact for traceability
#
# DATA PRIVACY:
#   All artifacts are written locally within the runner job.
#   Nothing is uploaded to external services unless you add an upload step.
#   To share artifacts, use actions/upload-artifact (see step below).

name: Agent Drift Detection (Nightly)

on:
  # Run every night at 03:00 UTC
  schedule:
    - cron: "0 3 * * *"
  # Allow manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      runs_per_case:
        description: "Number of runs per case for flakiness analysis (default: 5)"
        required: false
        default: "5"
      only_cases:
        description: "Comma-separated case IDs to run (empty = all)"
        required: false
        default: ""

env:
  # Your agent must be running at this URL during the job.
  # For self-hosted runners: start your agent as a background service before this step.
  AGENT_URL: http://localhost:8787
  RUNS_PER_CASE: ${{ github.event.inputs.runs_per_case || '5' }}

jobs:
  drift-detection:
    name: Nightly Agent Drift Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      # ----------------------------------------------------------------
      # START YOUR AGENT HERE
      # Replace this step with your actual agent startup command.
      # The agent must listen on $AGENT_URL/run-case before the runner starts.
      # ----------------------------------------------------------------
      - name: Start agent (replace with your agent startup)
        run: |
          # Example: npm run start:agent &
          # Example: docker run -d -p 8787:8787 my-agent:latest
          # Example: npx ts-node packages/agent-sdk/demo-agent.ts &
          echo "TODO: replace this step with your agent startup command"
          # Wait for agent to be ready
          # npx wait-on http://localhost:8787/health --timeout 30000
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      # ----------------------------------------------------------------
      # RUN: Flakiness mode (--runs N) for drift detection
      # The runner captures git_commit and git_branch automatically.
      # ----------------------------------------------------------------
      - name: Run agent evaluation suite (flakiness mode)
        run: |
          npx ts-node apps/runner/src/index.ts \
            --repoRoot . \
            --baseUrl "$AGENT_URL" \
            --cases cases/cases.json \
            --outDir apps/runner/runs \
            --runId drift-${{ github.run_id }} \
            --runs $RUNS_PER_CASE \
            --concurrency 2 \
            --timeoutMs 30000
        env:
          AQ_LICENSE_PUBLIC_KEY: ${{ secrets.AQ_LICENSE_PUBLIC_KEY }}
        continue-on-error: true  # Don't fail job here; evaluator decides the gate

      # ----------------------------------------------------------------
      # EVALUATE: Compare baseline vs new, generate report
      # ----------------------------------------------------------------
      - name: Run evaluator (generate compare-report + HTML)
        id: evaluator
        run: |
          npx ts-node apps/evaluator/src/index.ts \
            --repoRoot . \
            --baselineDir apps/runner/runs/baseline/drift-${{ github.run_id }} \
            --newDir apps/runner/runs/new/drift-${{ github.run_id }} \
            --cases cases/cases.json \
            --outDir apps/evaluator/reports/drift-${{ github.run_id }}
        env:
          AQ_LICENSE_PUBLIC_KEY: ${{ secrets.AQ_LICENSE_PUBLIC_KEY }}

      # ----------------------------------------------------------------
      # GATE: Read gate_recommendation from compare-report.json
      # Fails the job if gate_recommendation is "block"
      # ----------------------------------------------------------------
      - name: Check gate recommendation
        run: |
          GATE=$(node -e "
            const r = require('./apps/evaluator/reports/drift-${{ github.run_id }}/compare-report.json');
            const summary = r.summary || {};
            const block = Number(summary.cases_block_recommended || 0);
            const approve = Number(summary.cases_requiring_approval || 0);
            const gate = block > 0 ? 'block' : (approve > 0 ? 'require_approval' : 'none');
            console.log(gate);
          ")
          echo "Gate recommendation: $GATE"
          echo "gate=$GATE" >> $GITHUB_OUTPUT

          if [ "$GATE" = "block" ]; then
            echo "DRIFT DETECTED: gate_recommendation=block. Agent has regressed."
            exit 1
          elif [ "$GATE" = "require_approval" ]; then
            echo "WARNING: gate_recommendation=require_approval. Manual review required."
            # Does not fail the job â€” but creates a warning annotation
          fi
        id: gate

      # ----------------------------------------------------------------
      # FLAKINESS: Print flakiness summary to the job log
      # ----------------------------------------------------------------
      - name: Print flakiness summary
        if: always()
        run: |
          FLAKINESS_FILE="apps/runner/runs/new/drift-${{ github.run_id }}/flakiness.json"
          if [ -f "$FLAKINESS_FILE" ]; then
            echo "=== Flakiness Summary ==="
            node -e "
              const f = require('./' + '$FLAKINESS_FILE');
              const flaky = (f.cases || []).filter(c => c.new_pass_rate < 0.8);
              if (flaky.length === 0) {
                console.log('All cases: pass_rate >= 0.80 âœ“');
              } else {
                console.log('Flaky cases (pass_rate < 0.80):');
                flaky.forEach(c => console.log('  ' + c.case_id + ': ' + (c.new_pass_rate * 100).toFixed(0) + '%'));
              }
            "
          else
            echo "No flakiness.json found (--runs was 1 or runner failed)"
          fi

      # ----------------------------------------------------------------
      # UPLOAD ARTIFACTS: Store evidence pack for offline review
      # Artifacts available in GitHub Actions UI for 30 days
      # ----------------------------------------------------------------
      - name: Upload evidence pack
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: drift-evidence-${{ github.run_id }}
          path: |
            apps/evaluator/reports/drift-${{ github.run_id }}/
            apps/runner/runs/baseline/drift-${{ github.run_id }}/flakiness.json
            apps/runner/runs/new/drift-${{ github.run_id }}/flakiness.json
          retention-days: 30

      # ----------------------------------------------------------------
      # NOTIFY: On block, create a GitHub issue for the team
      # Optional â€” remove if not needed
      # ----------------------------------------------------------------
      - name: Create issue on drift detected
        if: failure() && steps.gate.outputs.gate == 'block'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "ðŸš¨ Agent Drift Detected â€” Nightly Run ${{ github.run_id }}",
              body: [
                "**Nightly drift detection found a regression.**",
                "",
                "- Run ID: `drift-${{ github.run_id }}`",
                "- Gate: `block`",
                "- Date: " + new Date().toISOString(),
                "",
                "Download the evidence pack from the [Actions run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}).",
                "",
                "Evidence pack contains: `compare-report.json`, `report.html`, `flakiness.json`."
              ].join("\n"),
              labels: ["agent-drift", "automated"]
            });
